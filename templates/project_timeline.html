{% extends "layout.html" %}

{% block title %}Project Timeline â€“ DesignAI{% endblock %}

{% block head %}
<style>
    /* ------------------------------------------------------------------- */
    /* COMPACT GLOBAL STYLES */
    /* ------------------------------------------------------------------- */
    .main-content {
        max-width: 1400px; /* EXPANDED TO 1400px for full widescreen feel */
        width: 95%; /* Ensures it takes up space on slightly smaller screens too */
        margin: 0 auto;
        padding: 1.5rem 1rem;
        font-family: 'Inter', sans-serif;
    }

    /* ------------------------------------------------------------------- */
    /* CARD STYLES */
    /* ------------------------------------------------------------------- */
    .timeline-card {
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 2rem; 
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
        width: 100%; /* Force full width */
    }

    /* Labels & Inputs */
    .timeline-input label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.35rem;
        color: #374151;
        font-size: 0.85rem; 
    }

    .timeline-input input, .timeline-input select {
        width: 100%;
        padding: 0.6rem 0.75rem; 
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background-color: #fff;
        font-size: 0.9rem;
        transition: border-color 0.15s;
    }

    .timeline-input input:focus, .timeline-input select:focus {
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
    }

    /* Button */
    .btn-primary {
        background-color: #10b981;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .btn-primary:hover:not(:disabled) { background-color: #059669; }
    .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }

    /* ------------------------------------------------------------------- */
    /* LOADING STATE */
    /* ------------------------------------------------------------------- */
    #loadingIndicator {
        display: none;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #059669;
        font-weight: 500;
        text-align: center; 
    }
    .spinner-sm {
        width: 18px;
        height: 18px;
        border: 2px solid #e5e7eb;
        border-top-color: #10b981;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ------------------------------------------------------------------- */
    /* RESULTS & TIMELINE */
    /* ------------------------------------------------------------------- */
    .total-summary {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .timeline-container {
        position: relative;
        padding-left: 24px; 
        margin-top: 0.5rem;
    }
    .timeline-container::before {
        content: '';
        position: absolute;
        top: 6px;
        bottom: 0;
        left: 7px;
        width: 2px;
        background-color: #e5e7eb;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.25rem; 
        padding-bottom: 0.25rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -21px; 
        top: 6px; 
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        border: 2px solid #fff;
        box-shadow: 0 0 0 1px #e5e7eb;
        z-index: 10;
        background-color: #fff; 
        border-color: #10b981;
    }

    .phase-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }

    .phase-name { font-weight: 700; color: #111827; font-size: 0.95rem; }
    .phase-dates { font-size: 0.8rem; color: #6b7280; }
    .phase-details { font-size: 0.85rem; color: #4b5563; margin-top: 0.25rem; line-height: 1.4; }

    /* Section Titles */
    h3 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0; }
    h4 { font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; }
    p.subtitle { font-size: 0.95rem; color: #6b7280; margin-top: 0.25rem; }

</style>
{% endblock %}

{% block content %}
<main class="main-content">
    
    <div class="mb-6">
        <h3>Project Timeline Scheduler</h3>
        <p class="subtitle">Enter details to estimate your renovation schedule.</p>
    </div>

    <div class="timeline-card w-full">
        
        <div class="timeline-input grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <div>
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" required>
            </div>
            <div>
                <label for="area">Area (Sq. Ft.)</label>
                <input type="number" id="area" placeholder="2000" value="2000" required>
            </div>
            <div>
                <label for="material">Material Quality</label>
                <select id="material">
                    <option value="Basic">Basic (6w lead)</option>
                    <option value="Premium" selected>Premium (8w lead)</option>
                    <option value="Luxury">Luxury (12w lead)</option>
                </select>
            </div>
            <div>
                <label for="homeType">Home Type</label>
                <select id="homeType">
                    <option value="2BHK" selected>2BHK</option>
                    <option value="3BHK">3BHK</option>
                    <option value="Villa">Villa</option>
                    <option value="Studio">Studio</option>
                </select>
            </div>

            <div>
                <label for="style">Style</label>
                <select id="style">
                    <option value="Minimal" selected>Minimal</option>
                    <option value="Industrial">Industrial</option>
                    <option value="Classic">Classic</option>
                    <option value="Modern">Modern</option>
                </select>
            </div>
            <div>
                <label for="workWeek">Work Schedule</label>
                <select id="workWeek">
                    <option value="5" selected>Mon-Fri (Standard)</option>
                    <option value="6">Mon-Sat (Faster)</option>
                    <option value="7">Every Day (Fastest)</option>
                </select>
            </div>
            <div>
                <label for="siteComplexity">Site Access</label>
                <select id="siteComplexity">
                    <option value="Easy" selected>Easy</option>
                    <option value="Standard">Standard</option>
                    <option value="Difficult">Difficult</option>
                </select>
            </div>
            <div>
                <label for="decisionSpeed">Approvals</label>
                <select id="decisionSpeed">
                    <option value="Fast">Fast (<48h)</option>
                    <option value="Standard" selected>Standard</option>
                    <option value="Slow">Slow (Delays)</option>
                </select>
            </div>
        </div>

        <div class="mt-8 flex flex-col items-center">
            <button id="generateTimelineBtn" class="btn-primary" style="min-width: 200px;">
                Calculate Timeline
            </button>
            
            <div id="loadingIndicator">
                <div class="spinner-sm"></div> Calculating schedule...
            </div>
        </div>
    </div>

    <div id="timelineResults" class="timeline-card" style="display:none; animation: fadeIn 0.3s ease-out;">
        
        <div class="total-summary">
            <div>
                <span class="text-xs text-gray-500 uppercase tracking-wide">Target Completion</span>
                <div id="completionDate" class="text-xl font-bold text-gray-800"></div>
            </div>
            <div class="text-right">
                <span class="text-xs text-gray-500 uppercase tracking-wide">Duration</span>
                <div class="text-xl font-bold text-green-600"><span id="totalDays"></span> Days</div>
            </div>
        </div>

        <h4>Phase Breakdown</h4>
        
        <div id="phasesContainer" class="timeline-container">
            </div>
    </div>

</main>

<script>
document.getElementById('generateTimelineBtn').addEventListener('click', async function() {
    const startDate = document.getElementById('startDate').value;
    const area = document.getElementById('area').value;
    
    if (!startDate || !area) {
        alert("Please set a Start Date and Area.");
        return;
    }

    const btn = this;
    const resultsDiv = document.getElementById('timelineResults');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // UI Loading State
    btn.disabled = true;
    loadingIndicator.style.display = 'block';
    resultsDiv.style.display = 'none';

    try {
        const requestData = {
            start_date: startDate,
            area: parseInt(area), 
            material: document.getElementById('material').value,
            home_type: document.getElementById('homeType').value,
            style: document.getElementById('style').value,
            work_week: parseInt(document.getElementById('workWeek').value),
            site_complexity: document.getElementById('siteComplexity').value,
            decision_speed: document.getElementById('decisionSpeed').value,
        };
        
        const response = await fetch('/api/timeline_generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (!data.success) {
            alert(`Error: ${data.error}`);
            return;
        }

        const timeline = data.timeline;

        // Populate Data
        document.getElementById('completionDate').textContent = timeline.end_date;
        document.getElementById('totalDays').textContent = timeline.total_project_days;
        
        const container = document.getElementById('phasesContainer');
        container.innerHTML = ''; 

        timeline.phases.forEach(phase => {
            container.innerHTML += `
                <div class="timeline-item">
                    <div class="phase-header">
                        <span class="phase-name">${phase.name}</span>
                        <span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${phase.duration_weeks} wks</span>
                    </div>
                    <div class="phase-dates">
                        ${phase.start_date} &rarr; ${phase.end_date}
                    </div>
                    <div class="phase-details">
                        ${phase.details}
                    </div>
                </div>
            `;
        });
        
        resultsDiv.style.display = 'block';
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (err) {
        console.error("Fetch Error:", err);
        alert("Error connecting to server.");
    } finally {
        btn.disabled = false;
        loadingIndicator.style.display = 'none';
    }
});
</script>
{% endblock %}