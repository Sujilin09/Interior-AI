<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Designer Dashboard{% endblock %} - DesignAI</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_homeowner.css') }}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <style>
        /* GLOBAL STYLES FOR SIDEBAR WIDGETS */
        .btn-green { background-color: #059669; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; text-decoration: none; }
        .btn-green:hover { background-color: #065F46; }

        .btn-dark { background-color: #333; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-dark:hover { background-color: #1a202c; }

        .btn-decline { background-color: #ef4444; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-decline:hover { background-color: #b91c1c; }

        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: bold; text-transform: capitalize; }
        .badge.pending { background-color: #fef3c7; color: #92400e; }
        .badge.confirmed { background-color: #d1fae5; color: #065f46; }
        .badge.declined { background-color: #fee2e2; color: #991b1b; }

        .card-actions { margin-top: 1rem; display: flex; gap: 10px; }

        .search-results-box {
            position: absolute;
            top: 48px;
            right: 0;
            width: 330px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            z-index: 5000 !important;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-item {
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .search-item:hover {
            background: #f3f4f6;
        }
    </style>

    {% block head %}{% endblock %}
</head>
<body>
    <div class="dashboard-container">
        
        <nav class="top-nav">
            <div class="nav-left">
                <div class="logo">DesignAI</div>
                <a href="{{ url_for('dashboard') }}" class="active">My Dashboard</a>
                <a href="{{ url_for('designer_profile') }}">Portfolio</a>
            </div>
            <div class="nav-right">
                    <div class="search-bar" style="position: relative;">
                    <i class='bx bx-search'></i>
                    <input id="globalSearch" type="text" placeholder="Search clients, projects...">
                    <div id="searchResults" class="search-results-box"></div>
                </div>
                <i class='bx bx-bell nav-icon'></i>
                <a href="{{ url_for('logout') }}" class="nav-icon" title="Logout"><i class='bx bx-log-out-circle'></i></a>
            </div>
        </nav>

        <aside class="sidebar-left">
            <div class="sidebar-header">
                Welcome, {{ user.name.split(' ')[0] | default('Designer') }}!
            </div>
            <ul class="sidebar-menu">
                <li><a href="{{ url_for('dashboard') }}" class="active"><i class='bx bx-grid-alt'></i> My Dashboard</a></li>
                <li><a href="{{ url_for('designer_profile') }}"><i class='bx bx-user-circle'></i> My Portfolio</a></li>
                <li><a href="{{ url_for('designer_analytics') }}"><i class='bx bx-bar-chart-alt-2'></i> Analytics</a></li>
                <li><a href="#"><i class='bx bx-calendar-check'></i> My Bookings</a></li>
                <li><a href="#"><i class='bx bx-wallet'></i> Earnings</a></li>
            </ul>
        </aside>

        {% block content %}{% endblock %}
        
        <aside class="sidebar-right">
            
            <div class="card">
                <h4>Client Requests</h4>
                {% if upcoming_schedule %}
                    {% for s in upcoming_schedule %}
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f0f0f0;">
                        <div style="display:flex; justify-content:space-between; align-items: center;">
                            <p style="font-weight:bold; margin: 0;">{{ s.notes or "Client Request" }}</p>
                            <span class="badge {{ s.booking_status }}" id="badge-{{ s.id }}">
                                {{ s.booking_status }}
                            </span>
                        </div>
                        <small style="color:#6b7280;">From: {{ s.user_name or 'a user' }}</small><br>
                        <small style="color:#6b7280;">On: {{ s.booking_date | datetimeformat }}</small>
                        
                        {% if s.booking_status == 'pending' %}
                        <div class="card-actions" id="actions-{{ s.id }}">
                            <button class="btn-green btn-action" data-booking-id="{{ s.id }}" data-action="confirmed">Accept</button>
                            <button class="btn-dark btn-action" data-booking-id="{{ s.id }}" data-action="chat">Chat</button>
                            <button class="btn-decline btn-action" data-booking-id="{{ s.id }}" data-action="declined">Decline</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-placeholder" style="margin: 0;">No new client requests.</p>
                {% endif %}
            </div>

            <div class="card">
                <h4>Earnings ({{ current_month }})</h4>
                <h2 style="font-size: 1.8rem; color: #059669; margin: 0.5rem 0;">
                    Rs.{{ "{:,.0f}".format(total_earnings | default(0)) }}
                </h2>
                <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                    <span>Pending Payout</span>
                    <span style="color:#ef4444; font-weight: bold;">Rs.{{ "{:,.0f}".format(pending_earnings | default(0)) }}</span>
                </div>
                <button class="btn-secondary full-width" style="margin-top: 1rem;">Payout Settings</button>
            </div>

            <div class="card">
                <h4>Popular Styles</h4>
                <div style="font-size:0.9rem; margin-top: 1rem;">
                    {% for item in popular_styles %}
                    <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem;">
                        <span>{{ item.style }}</span>
                        <span style="font-weight: bold;">{{ item.percent }}%</span>
                    </div>
                    {% else %}
                    <p style="color:#6b7280;">No style data yet.</p>
                    {% endfor %}
                </div>
            </div>
            
            {% block sidebar_right %}{% endblock %}
        </aside>

    </div>
    
<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ------------------------------------------------------
       CLIENT REQUEST STATUS BUTTONS (unchanged)
    ------------------------------------------------------*/
    document.querySelectorAll('.btn-action').forEach(button => {
        button.addEventListener('click', async (e) => {
            e.preventDefault();
            const bookingId = button.dataset.bookingId;
            const action = button.dataset.action;

            if (action === "chat") {
                alert("Chat feature coming soon!");
                return;
            }

            const badge = document.getElementById(`badge-${bookingId}`);
            const actions = document.getElementById(`actions-${bookingId}`);

            try {
                const response = await fetch(`/api/booking/update/${bookingId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: action })
                });

                const data = await response.json();
                if (data.status === "success") {
                    badge.textContent = data.new_status;
                    badge.className = `badge ${data.new_status}`;
                    actions.style.display = "none";
                }

            } catch (err) {
                console.error(err);
            }
        });
    });

    /* ------------------------------------------------------
       GLOBAL SEARCH BAR â€” CLEAN & WORKING
    ------------------------------------------------------*/
    const searchInput = document.getElementById("globalSearch");
    const resultsBox  = document.getElementById("searchResults");

    searchInput.addEventListener("input", () => {
        const q = searchInput.value.trim().toLowerCase();
        resultsBox.innerHTML = "";

        if (!q) {
            resultsBox.style.display = "none";
            return;
        }

        let results = [];

        /* --- Search Projects --- */
        document.querySelectorAll(".portfolio-item").forEach(card => {
            const title = (card.querySelector("p")?.innerText || "").toLowerCase();
            const room  = (card.querySelector("small")?.innerText || "").toLowerCase();

            if (title.includes(q) || room.includes(q)) {
                results.push({ type: "Project", text: title });
            }
        });

        /* --- Search Client Requests --- */
        document.querySelectorAll(".sidebar-right .card:first-child div").forEach(block => {
            const note = (block.querySelector("p")?.innerText || "").toLowerCase();
            const name = (block.querySelector("small")?.innerText || "").toLowerCase();

            if (note.includes(q) || name.includes(q)) {
                results.push({ type: "Client", text: note });
            }
        });

        /* --- Display Results --- */
        if (results.length === 0) {
            resultsBox.innerHTML = `<div class="search-item">No results found</div>`;
        } else {
            results.forEach(r => {
                const item = document.createElement("div");
                item.className = "search-item";
                item.innerHTML = `<strong>${r.type}:</strong> ${r.text}`;
                item.addEventListener("click", () => handleSearchClick(r));
                resultsBox.appendChild(item);
            });
        }

        resultsBox.style.display = "block";
    });

    /* Hide dropdown when clicking outside */
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-bar")) {
            resultsBox.style.display = "none";
        }
    });

    /* ------------------------------------------------------
       HANDLERS FOR CLICKING RESULTS
    ------------------------------------------------------*/
    function handleSearchClick(result) {
        resultsBox.style.display = "none";
        searchInput.value = "";

        if (result.type === "Project") scrollToProject(result.text);
        if (result.type === "Client") scrollToClient(result.text);
    }

    /* --- Scroll to Project --- */
    function scrollToProject(text) {
        document.querySelectorAll(".portfolio-item").forEach(card => {
            const title = (card.querySelector("p")?.innerText || "").toLowerCase();
            if (title.includes(text)) {
                card.scrollIntoView({ behavior: "smooth", block: "center" });
                card.style.boxShadow = "0 0 0 3px #059669";
                setTimeout(() => card.style.boxShadow = "none", 1500);
            }
        });
    }

    /* --- Scroll to Client Request --- */
    function scrollToClient(text) {
        document.querySelectorAll(".sidebar-right .card:first-child div").forEach(block => {
            const note = (block.querySelector("p")?.innerText || "").toLowerCase();
            if (note.includes(text)) {
                block.scrollIntoView({ behavior: "smooth", block: "center" });
                block.style.background = "#d1fae5";
                setTimeout(() => block.style.background = "transparent", 1500);
            }
        });
    }

});
</script>

    
    {% block scripts %}{% endblock %}
</body>

</html>